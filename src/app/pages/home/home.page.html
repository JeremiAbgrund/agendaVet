<ion-header class="home-header" translucent="true">
  <ion-toolbar color="transparent">
    <ion-title>AgendaVet</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" color="medium" (click)="logout()" aria-label="Cerrar sesión">
        <ion-icon name="log-out-outline"></ion-icon>
      </ion-button>
      <ion-button fill="clear" class="avatar-btn" (click)="goHome()" aria-label="Volver al inicio">
        <ion-avatar>
          <img src="assets/img/pet-avatar.svg" alt="Avatar de usuario" />
        </ion-avatar>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="home-content" [fullscreen]="true">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content pullingIcon="chevron-down-outline" refreshingSpinner="crescent"
      pullingText="Desliza para actualizar" refreshingText="Sincronizando...">
    </ion-refresher-content>
  </ion-refresher>

  <section class="hero-card ion-padding-horizontal" #heroBlock>
    <div *ngIf="userProfile">
      <p class="eyebrow">Hola, {{ userProfile.ownerName }}</p>
      <h1>Hoy tienes {{ stats[0].value }} citas activas</h1>
      <p class="subtitle">Gestiona tus mascotas desde un solo lugar.</p>
      <ion-chip color="light" outline="true">
        <ion-icon name="home-outline" aria-hidden="true"></ion-icon>
        <ion-label>{{ userProfile.clinic }}</ion-label>
      </ion-chip>
    </div>
  </section>

  <ion-card class="next-appointment ion-margin">
    <ion-card-header>
      <ion-card-subtitle>Próxima cita</ion-card-subtitle>
      <ion-card-title>{{ nextAppointment.petName }} · {{ nextAppointment.type }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-item lines="none">
        <ion-icon name="calendar-outline" slot="start"></ion-icon>
        <ion-label>
          <h3>{{ nextAppointment.date }}</h3>
          <p>{{ nextAppointment.time }}</p>
        </ion-label>
        <ion-badge color="success" *ngIf="nextAppointment.status === 'confirmada'">
          Confirmada
        </ion-badge>
      </ion-item>
      <ion-item lines="none">
        <ion-icon name="medkit-outline" slot="start"></ion-icon>
        <ion-label>
          <h3>{{ nextAppointment.vet }}</h3>
          <p>{{ nextAppointment.location }}</p>
        </ion-label>
      </ion-item>
      <ion-note color="medium">
        {{ nextAppointment.notes }}
      </ion-note>
    </ion-card-content>
  </ion-card>

  <div class="manage-link ion-text-center">
    <ion-button size="small" fill="outline" routerLink="/gestionar-citas">
      Gestionar citas agendadas
    </ion-button>
  </div>

  <section class="stats-grid ion-padding-horizontal">
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="4" *ngFor="let stat of stats">
          <ion-card #statCard>
            <ion-card-content>
              <ion-icon [name]="stat.icon" [color]="stat.color"></ion-icon>
              <h2>{{ stat.value }}</h2>
              <p>{{ stat.label }}</p>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </section>

  <section class="quick-actions ion-padding-horizontal">
    <h2>Accesos rápidos</h2>
    <ion-grid>
      <ion-row>
        <ion-col size="6" *ngFor="let action of quickActions">
          <ion-button expand="block" [color]="action.color" (click)="handleQuickAction(action)">
            <ion-icon slot="start" [name]="action.icon"></ion-icon>
            {{ action.label }}
          </ion-button>
        </ion-col>
      </ion-row>
    </ion-grid>
  </section>

  <section class="reminders ion-padding-horizontal">
    <div class="section-header">
      <h2>
        Recordatorios
        <ion-icon
          class="bell-toggle"
          [name]="remindersMuted ? 'notifications-off-outline' : 'notifications-outline'"
          (click)="toggleMuteReminders()"
          [class.muted]="remindersMuted"></ion-icon>
      </h2>
      <ion-button size="small" fill="clear" (click)="addReminderPrompt()">
        <ion-icon slot="start" name="add-outline"></ion-icon>
        Agregar
      </ion-button>
    </div>
    <ion-list lines="inset">
      <ion-item *ngFor="let reminder of reminders">
        <ion-icon slot="start" [name]="reminder.icon" color="secondary"></ion-icon>
        <ion-label>
          <h3>{{ reminder.pet }} · {{ reminder.task }}</h3>
          <p>{{ reminder.due }}</p>
        </ion-label>
        <ion-toggle
          [checked]="reminder.done"
          [disabled]="remindersMuted"
          (ionChange)="toggleReminder(reminder, $event)"
          aria-label="Marcar recordatorio completado"></ion-toggle>
        <ion-button fill="clear" color="danger" slot="end" (click)="removeReminder(reminder.id)">
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-button>
      </ion-item>
    </ion-list>
  </section>

  <section class="tips ion-padding-horizontal" *ngIf="remoteTips.length">
    <div class="section-header">
      <h2>Tips de cuidado</h2>
      <ion-badge color="medium" *ngIf="remoteTipsFromCache">Datos locales</ion-badge>
    </div>
    <ion-list lines="inset">
      <ion-item *ngFor="let tip of remoteTips">
        <ion-icon slot="start" name="bulb-outline" color="primary"></ion-icon>
        <ion-label>
          <p>{{ tip.title }}</p>
        </ion-label>
        <ion-badge [color]="tip.completed ? 'success' : 'warning'">
          {{ tip.completed ? 'Hecho' : 'Pendiente' }}
        </ion-badge>
      </ion-item>
    </ion-list>
  </section>

  <section class="upcoming ion-padding-horizontal">
    <h2>Próximas citas</h2>
    <ion-list>
      <ion-item *ngFor="let appointment of upcomingAppointments">
        <ion-avatar slot="start">
          <ion-icon name="paw-outline"></ion-icon>
        </ion-avatar>
        <ion-label>
          <h3>{{ appointment.petName }} · {{ appointment.type }}</h3>
          <p>{{ appointment.date }} · {{ appointment.vet }}</p>
          <ion-note color="medium">{{ appointment.notes }}</ion-note>
        </ion-label>
        <ion-badge [color]="appointment.status === 'confirmada' ? 'success' : 'warning'">
          {{ appointment.status }}
        </ion-badge>
      </ion-item>
    </ion-list>
  </section>
</ion-content>
